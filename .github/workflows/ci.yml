name: Client CI

on:
  push:
    branches: [ main ]
  pull_request: 

jobs:
  client-ci: 
    runs-on: ubuntu-latest
    
    steps: 
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'client/package-lock.json'
    
    - name: Install dependencies
      working-directory: client
      run: npm ci
    
    - name: Run lint
      working-directory: client
      run: npm run lint
    
    - name: Build
      working-directory: client
      run: npm run build
    
    - name: Run tests
      working-directory: client
      run: npm test

  client-e2e:
    runs-on: ubuntu-latest
    needs: client-ci
    
    steps:
    - uses: actions/checkout@v4
    
    # Checkout backend repository
    - name: Checkout backend repository
      id: checkout-backend
      uses: actions/checkout@v4
      with:
        repository: blecx/AI-Agent-Framework
        path: backend
      continue-on-error: false  # Fail if backend not accessible
    
    # Setup Python for backend
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt
    
    # Setup Node.js for client
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with: 
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'client/package-lock.json'
    
    # Analyze backend structure and determine startup method
    - name: Analyze backend structure
      id: analyze-backend
      working-directory: backend
      run: |
        echo "::group::Backend Structure Analysis"
        echo "Analyzing backend repository structure..."
        
        # Check for E2E test harness (recommended approach)
        if [ -f "backend_e2e_runner.py" ]; then
          echo "✓ Found backend_e2e_runner.py (E2E test harness)"
          echo "BACKEND_METHOD=e2e_harness" >> $GITHUB_OUTPUT
          echo "BACKEND_METHOD=e2e_harness" >> $GITHUB_ENV
        # Check for docker-compose
        elif [ -f "docker-compose.yml" ]; then
          echo "✓ Found docker-compose.yml"
          echo "BACKEND_METHOD=docker_compose" >> $GITHUB_OUTPUT
          echo "BACKEND_METHOD=docker_compose" >> $GITHUB_ENV
        # Check for standard Python app structure
        elif [ -f "requirements.txt" ]; then
          echo "⚠ No E2E harness found, checking for FastAPI app..."
          
          # Look for FastAPI entry point
          if [ -f "main.py" ]; then
            echo "✓ Found main.py"
            echo "ENTRY_POINT=main:app" >> $GITHUB_ENV
            echo "BACKEND_METHOD=uvicorn" >> $GITHUB_OUTPUT
            echo "BACKEND_METHOD=uvicorn" >> $GITHUB_ENV
          elif [ -f "apps/main.py" ]; then
            echo "✓ Found apps/main.py"
            echo "ENTRY_POINT=apps.main:app" >> $GITHUB_ENV
            echo "BACKEND_METHOD=uvicorn" >> $GITHUB_OUTPUT
            echo "BACKEND_METHOD=uvicorn" >> $GITHUB_ENV
          else
            echo "✗ ERROR: Cannot determine backend startup method"
            echo "Available files:"
            ls -la
            echo ""
            echo "RESOLUTION REQUIRED:"
            echo "The backend repository must provide one of:"
            echo "  1. backend_e2e_runner.py (recommended for E2E tests)"
            echo "  2. docker-compose.yml (for Docker-based setup)"
            echo "  3. main.py or apps/main.py (for direct FastAPI startup)"
            echo ""
            echo "See docs/E2E-BACKEND-REQUIREMENTS.md for details"
            echo "BACKEND_METHOD=none" >> $GITHUB_OUTPUT
            echo "BACKEND_METHOD=none" >> $GITHUB_ENV
            exit 1
          fi
        else
          echo "✗ ERROR: No requirements.txt found"
          echo "BACKEND_METHOD=none" >> $GITHUB_OUTPUT
          echo "BACKEND_METHOD=none" >> $GITHUB_ENV
          exit 1
        fi
        echo "::endgroup::"
    
    # Install backend dependencies
    - name: Install backend dependencies
      working-directory: backend
      run: |
        echo "::group::Installing Backend Dependencies"
        pip install -r requirements.txt
        echo "Installed packages:"
        pip list | grep -E "(fastapi|uvicorn|pytest)" || true
        echo "::endgroup::"
    
    # Start backend using determined method
    - name: Start backend API
      id: start-backend
      working-directory: backend
      env:
        PROJECT_DOCS_PATH: /tmp/test-docs
        PORT: 8000
        HOST: 0.0.0.0
      run: |
        echo "::group::Starting Backend"
        mkdir -p /tmp/test-docs
        mkdir -p config
        echo '{}' > config/llm.json || true
        
        METHOD="${{env.BACKEND_METHOD}}"
        echo "Using startup method: $METHOD"
        
        case "$METHOD" in
          e2e_harness)
            echo "Starting backend with E2E harness..."
            python backend_e2e_runner.py > /tmp/backend.log 2>&1 &
            echo $! > /tmp/backend.pid
            ;;
          docker_compose)
            echo "Starting backend with docker-compose..."
            docker-compose up -d
            ;;
          uvicorn)
            ENTRY="${{env.ENTRY_POINT}}"
            echo "Starting backend with uvicorn ($ENTRY)..."
            nohup uvicorn $ENTRY --host 0.0.0.0 --port 8000 --log-level info > /tmp/backend.log 2>&1 &
            echo $! > /tmp/backend.pid
            ;;
          *)
            echo "ERROR: Invalid backend method: $METHOD"
            exit 1
            ;;
        esac
        
        # Give backend time to initialize
        sleep 5
        
        # Verify process is running
        if [ -f /tmp/backend.pid ]; then
          if ps -p $(cat /tmp/backend.pid) > /dev/null 2>&1; then
            echo "✓ Backend process is running (PID: $(cat /tmp/backend.pid))"
          else
            echo "✗ Backend process died immediately"
            echo "Log contents:"
            cat /tmp/backend.log || echo "No log available"
            exit 1
          fi
        fi
        echo "::endgroup::"
    
    # Wait for backend health check
    - name: Wait for backend to be ready
      run: |
        echo "::group::Waiting for Backend Health Check"
        echo "Polling http://localhost:8000/health..."
        ATTEMPT=0
        MAX_ATTEMPTS=60
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
            echo "✓ Backend is healthy! (attempt $ATTEMPT/$MAX_ATTEMPTS)"
            curl -s http://localhost:8000/health
            echo "::endgroup::"
            exit 0
          fi
          
          if [ $((ATTEMPT % 10)) -eq 0 ]; then
            echo "Still waiting... (attempt $ATTEMPT/$MAX_ATTEMPTS)"
          fi
          sleep 2
        done
        
        echo "✗ Backend failed to become healthy after $MAX_ATTEMPTS attempts"
        echo ""
        echo "Backend logs:"
        cat /tmp/backend.log || echo "No log file found"
        echo ""
        echo "Process status:"
        ps aux | grep -E "(uvicorn|python)" || echo "No backend process found"
        echo "::endgroup::"
        exit 1
    
    # Install client dependencies
    - name: Install client dependencies
      working-directory: client
      run: npm ci
    
    # Install Playwright browsers
    - name: Install Playwright browsers
      working-directory: client
      run: npx playwright install --with-deps chromium
    
    # Run E2E tests
    - name: Run Playwright E2E tests
      working-directory: client
      env:
        E2E_BASE_URL: http://localhost:3000
        API_BASE_URL: http://localhost:8000
        CI: true
      run: |
        echo "::group::Running E2E Tests"
        npx playwright test
        echo "::endgroup::"
    
    # Upload test report on failure
    - name: Upload Playwright Report
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: client/playwright-report/
        retention-days: 30
    
    # Upload screenshots on failure
    - name: Upload Test Screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-screenshots
        path: client/test-results/
        retention-days: 30
    
    # Upload backend logs on failure
    - name: Upload Backend Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: backend-logs
        path: /tmp/backend.log
        retention-days: 30
    
    # Clean up backend
    - name: Stop backend
      if: always()
      working-directory: backend
      run: |
        echo "::group::Stopping Backend"
        METHOD="${{env.BACKEND_METHOD}}"
        
        case "$METHOD" in
          docker_compose)
            echo "Stopping docker-compose services..."
            docker-compose down || true
            ;;
          *)
            if [ -f /tmp/backend.pid ]; then
              PID=$(cat /tmp/backend.pid)
              echo "Stopping backend process (PID: $PID)..."
              kill $PID 2>/dev/null || true
              sleep 2
              kill -9 $PID 2>/dev/null || true
            fi
            ;;
        esac
        echo "::endgroup::"
