name: Client CI

on:
  push:
    branches: [ main ]
  pull_request: 

jobs:
  client-ci: 
    runs-on: ubuntu-latest
    
    steps: 
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'client/package-lock.json'
    
    - name: Install dependencies
      working-directory: client
      run: npm ci
    
    - name: Run lint
      working-directory: client
      run: npm run lint
    
    - name: Build
      working-directory: client
      run: npm run build
    
    - name: Run tests
      working-directory: client
      run: npm test

  client-e2e:
    runs-on: ubuntu-latest
    needs: client-ci
    # Only run E2E tests if explicitly enabled or on main branch
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event.pull_request.labels.*.name == 'run-e2e'
    
    steps:
    - uses: actions/checkout@v4
    
    # Checkout backend repository (optional - only if available)
    - name: Checkout backend
      id: checkout-backend
      continue-on-error: true
      uses: actions/checkout@v4
      with:
        repository: blecx/AI-Agent-Framework
        path: backend
    
    # Setup Python for backend
    - name: Setup Python
      if: steps.checkout-backend.outcome == 'success'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt
    
    # Setup Node.js for client
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with: 
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'client/package-lock.json'
    
    # Install backend dependencies and start server
    - name: Install backend dependencies
      if: steps.checkout-backend.outcome == 'success'
      working-directory: backend
      run: |
        pip install -r requirements.txt
    
    - name: Start backend API
      if: steps.checkout-backend.outcome == 'success'
      working-directory: backend
      env:
        PROJECT_DOCS_PATH: /tmp/test-docs
        PORT: 8000
        HOST: 0.0.0.0
      run: |
        mkdir -p /tmp/test-docs
        # Create minimal config if needed
        mkdir -p config
        echo '{}' > config/llm.json || true
        
        # Look for the backend E2E harness
        if [ -f "backend_e2e_runner.py" ]; then
          echo "Using backend E2E harness"
          python backend_e2e_runner.py &
          echo $! > /tmp/backend.pid
        else
          # Try docker-compose as fallback
          if [ -f "docker-compose.yml" ]; then
            echo "Using docker-compose"
            docker-compose up -d
          else
            echo "⚠️ No E2E harness or docker-compose found"
            echo "Skipping backend startup"
            exit 0
          fi
        fi
        
        sleep 5
    
    - name: Wait for backend to be ready
      if: steps.checkout-backend.outcome == 'success'
      run: |
        echo "Waiting for backend API..."
        for i in {1..30}; do
          if curl -f http://localhost:8000/health 2>/dev/null; then
            echo "Backend API is ready!"
            exit 0
          fi
          echo "Attempt $i/30 - waiting..."
          sleep 2
        done
        echo "⚠️ Backend did not become ready, but continuing..."
        echo "E2E tests will be skipped or may fail"
    
    # Install client dependencies and run tests
    - name: Install dependencies
      working-directory: client
      run: npm ci
    
    - name: Install Playwright browsers
      working-directory: client
      run: npx playwright install --with-deps chromium
    
    - name: Run Playwright tests
      working-directory: client
      env:
        E2E_BASE_URL: http://localhost:3000
        API_BASE_URL: http://localhost:8000
        CI: true
      # Continue on error if backend isn't available
      continue-on-error: ${{ steps.checkout-backend.outcome != 'success' }}
      run: npx playwright test
    
    - name: Upload Playwright Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: client/playwright-report/
        retention-days: 30
    
    - name: Upload Test Screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-screenshots
        path: client/test-results/
        retention-days: 30
    
    - name: Upload Backend Logs
      if: failure() && steps.checkout-backend.outcome == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: backend-logs
        path: /tmp/backend.log
        retention-days: 30
    
    - name: Stop backend
      if: always() && steps.checkout-backend.outcome == 'success'
      run: |
        # Stop docker-compose if it was used
        if [ -f backend/docker-compose.yml ]; then
          cd backend && docker-compose down || true
        fi
        # Stop background process if it exists
        if [ -f /tmp/backend.pid ]; then
          kill $(cat /tmp/backend.pid) 2>/dev/null || true
        fi
