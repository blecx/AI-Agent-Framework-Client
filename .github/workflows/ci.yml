name: Client CI

on:
  push:
    branches: [ main ]
  pull_request: 

jobs:
  client-ci: 
    runs-on: ubuntu-latest
    
    steps: 
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'client/package-lock.json'
    
    - name: Install dependencies
      working-directory: client
      run: npm ci
    
    - name: Run lint
      working-directory: client
      run: npm run lint
    
    - name: Build
      working-directory: client
      run: npm run build
    
    - name: Run tests
      working-directory: client
      run: npm test

  client-e2e:
    runs-on: ubuntu-latest
    needs: client-ci
    
    services:
      # Backend API service for E2E tests
      backend:
        image: ghcr.io/blecx/ai-agent-framework:latest
        ports:
          - 8000:8000
        env:
          PROJECT_DOCS_PATH: /tmp/test-docs
          PORT: 8000
          HOST: 0.0.0.0
        options: >-
          --health-cmd "curl -f http://localhost:8000/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with: 
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'client/package-lock.json'
    
    - name: Install dependencies
      working-directory: client
      run: npm ci
    
    - name: Install Playwright browsers
      working-directory: client
      run: npx playwright install --with-deps chromium
    
    - name: Wait for backend to be ready
      run: |
        echo "Waiting for backend API..."
        timeout 60 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done'
        echo "Backend API is ready!"
    
    - name: Run Playwright tests
      working-directory: client
      env:
        E2E_BASE_URL: http://localhost:3000
        API_BASE_URL: http://localhost:8000
        CI: true
      run: npx playwright test
    
    - name: Upload Playwright Report
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: client/playwright-report/
        retention-days: 30
    
    - name: Upload Test Screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-screenshots
        path: client/test-results/
        retention-days: 30
