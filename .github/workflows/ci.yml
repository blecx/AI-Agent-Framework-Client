name: Client CI

on:
  push:
    branches: [ main ]
  pull_request: 

jobs:
  client-ci: 
    runs-on: ubuntu-latest
    
    steps: 
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'client/package-lock.json'
    
    - name: Install dependencies
      working-directory: client
      run: npm ci
    
    - name: Run lint
      working-directory: client
      run: npm run lint
    
    - name: Build
      working-directory: client
      run: npm run build
    
    - name: Run tests
      working-directory: client
      run: npm test

  client-e2e:
    runs-on: ubuntu-latest
    needs: client-ci
    
    steps:
    - uses: actions/checkout@v4
    
    # Checkout backend repository
    - name: Checkout backend
      uses: actions/checkout@v4
      with:
        repository: blecx/AI-Agent-Framework
        path: backend
    
    # Setup Python for backend
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt
    
    # Setup Node.js for client
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with: 
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'client/package-lock.json'
    
    # Install backend dependencies and start server
    - name: Install backend dependencies
      working-directory: backend
      run: |
        pip install -r requirements.txt
    
    - name: Verify backend structure
      working-directory: backend
      run: |
        echo "Backend directory contents:"
        ls -la
        echo ""
        echo "Checking for FastAPI application entry point:"
        # Look for common entry points
        if [ -f "main.py" ]; then
          echo "✓ main.py found at root"
          echo "ENTRY_POINT=main:app" >> $GITHUB_ENV
        elif [ -f "apps/main.py" ]; then
          echo "✓ apps/main.py found"
          echo "ENTRY_POINT=apps.main:app" >> $GITHUB_ENV
        elif [ -f "apps/api/main.py" ]; then
          echo "✓ apps/api/main.py found"
          echo "ENTRY_POINT=apps.api.main:app" >> $GITHUB_ENV
        else
          echo "⚠ Checking apps directory for entry point..."
          find apps -name "*.py" -type f | head -5
          # Try to find __main__.py or app.py
          if [ -f "apps/__main__.py" ]; then
            echo "✓ apps/__main__.py found"
            echo "ENTRY_POINT=apps:app" >> $GITHUB_ENV
          elif [ -f "apps/app.py" ]; then
            echo "✓ apps/app.py found"
            echo "ENTRY_POINT=apps.app:app" >> $GITHUB_ENV
          else
            echo "✗ Could not find FastAPI entry point"
            echo "Trying to read README or documentation..."
            if [ -f "README.md" ]; then
              echo "README contents (first 50 lines):"
              head -50 README.md | grep -A 5 -i "run\|start\|uvicorn" || echo "No startup instructions found"
            fi
            exit 1
          fi
        fi
        echo ""
        echo "Python packages installed:"
        pip list | grep -E "(fastapi|uvicorn)" || echo "Warning: FastAPI or Uvicorn not found"
    
    - name: Start backend API
      working-directory: backend
      env:
        PROJECT_DOCS_PATH: /tmp/test-docs
        PORT: 8000
        HOST: 0.0.0.0
      run: |
        mkdir -p /tmp/test-docs
        # Create minimal config if needed
        mkdir -p config
        echo '{}' > config/llm.json || true
        
        # Use the entry point discovered in the previous step
        ENTRY=${ENTRY_POINT:-main:app}
        echo "Starting backend with entry point: $ENTRY"
        
        # Start backend in background
        nohup uvicorn $ENTRY --host 0.0.0.0 --port 8000 --log-level debug > /tmp/backend.log 2>&1 &
        echo $! > /tmp/backend.pid
        echo "Backend started with PID $(cat /tmp/backend.pid)"
        
        # Give it a moment to start
        sleep 3
        
        # Check if process is still running
        if ps -p $(cat /tmp/backend.pid) > /dev/null; then
          echo "✓ Backend process is running"
        else
          echo "✗ Backend process died. Log contents:"
          cat /tmp/backend.log
          exit 1
        fi
    
    - name: Wait for backend to be ready
      run: |
        echo "Waiting for backend API..."
        for i in {1..30}; do
          if curl -f http://localhost:8000/health 2>/dev/null; then
            echo "Backend API is ready!"
            exit 0
          fi
          echo "Attempt $i/30 - waiting..."
          sleep 2
        done
        echo "Backend failed to start. Logs:"
        cat /tmp/backend.log || echo "No log file found"
        echo ""
        echo "Checking if backend process is still running:"
        ps aux | grep uvicorn || echo "No uvicorn process found"
        exit 1
    
    # Install client dependencies and run tests
    - name: Install dependencies
      working-directory: client
      run: npm ci
    
    - name: Install Playwright browsers
      working-directory: client
      run: npx playwright install --with-deps chromium
    
    - name: Run Playwright tests
      working-directory: client
      env:
        E2E_BASE_URL: http://localhost:3000
        API_BASE_URL: http://localhost:8000
        CI: true
      run: npx playwright test
    
    - name: Upload Playwright Report
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: client/playwright-report/
        retention-days: 30
    
    - name: Upload Test Screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-screenshots
        path: client/test-results/
        retention-days: 30
    
    - name: Upload Backend Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: backend-logs
        path: /tmp/backend.log
        retention-days: 30
    
    - name: Stop backend
      if: always()
      run: |
        if [ -f /tmp/backend.pid ]; then
          kill $(cat /tmp/backend.pid) 2>/dev/null || true
        fi
