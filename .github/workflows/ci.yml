name: Client CI

on:
  push:
    branches: [ main ]
  pull_request: 

jobs:
  client-ci: 
    runs-on: ubuntu-latest
    
    steps: 
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'client/package-lock.json'
    
    - name: Install dependencies
      working-directory: client
      run: npm ci
    
    - name: Run lint
      working-directory: client
      run: npm run lint
    
    - name: Build
      working-directory: client
      run: npm run build
    
    - name: Run tests
      working-directory: client
      run: npm test

  # E2E tests with smart dependency resolution
  # This job implements intelligent backend dependency resolution:
  # 1. Attempts to resolve all dependencies automatically
  # 2. Only skips tests if dependencies are truly unresolvable
  # 3. Logs detailed reasons for any skipped tests
  # For details, see docs/E2E-CI-DEPENDENCY-RESOLUTION.md
  client-e2e:
    runs-on: ubuntu-latest
    needs: client-ci
    # Run on main branch or when 'run-e2e' label is present
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'run-e2e')
    
    steps:
      - name: Checkout client repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'client/package-lock.json'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install client dependencies
        working-directory: client
        run: npm ci
      
      - name: Install Playwright browsers
        working-directory: client
        run: npx playwright install --with-deps chromium
      
      - name: Attempt backend dependency resolution
        id: backend_setup
        run: |
          echo "=== Smart Backend Dependency Resolution ==="
          echo "Starting dependency resolution process..."
          echo ""
          
          # Set backend directory in CI environment
          export BACKEND_DIR="${GITHUB_WORKSPACE}/../AI-Agent-Framework"
          export LOG_FILE="${GITHUB_WORKSPACE}/backend-setup.log"
          
          # Run the smart setup script
          if bash client/e2e/setup-backend.sh; then
            echo "backend_available=true" >> $GITHUB_OUTPUT
            echo ""
            echo "✓ Backend setup successful"
          else
            echo "backend_available=false" >> $GITHUB_OUTPUT
            echo ""
            echo "✗ Backend setup failed"
            echo "See backend-setup.log for details"
          fi
        continue-on-error: true
      
      - name: Display backend setup log
        if: always()
        run: |
          if [ -f backend-setup.log ]; then
            echo "=== Backend Setup Log ==="
            cat backend-setup.log
          fi
      
      - name: Run E2E tests
        if: steps.backend_setup.outputs.backend_available == 'true'
        working-directory: client
        run: npx playwright test
        env:
          E2E_BASE_URL: http://localhost:5173
          API_BASE_URL: http://localhost:8000
      
      - name: Skip E2E tests with reason
        if: steps.backend_setup.outputs.backend_available != 'true'
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════════"
          echo "E2E TESTS SKIPPED - DEPENDENCY RESOLUTION FAILED"
          echo "═══════════════════════════════════════════════════════════"
          echo ""
          echo "The E2E tests were skipped because backend dependencies"
          echo "could not be resolved automatically."
          echo ""
          echo "ATTEMPTED RESOLUTION METHODS:"
          echo "  1. Clone backend repository from GitHub"
          echo "  2. Start backend via Docker Compose"
          echo "  3. Create Python venv and install dependencies"
          echo "  4. Start backend via uvicorn"
          echo ""
          echo "All methods failed. See backend-setup.log artifact for details."
          echo ""
          echo "TO FIX:"
          echo "  - Ensure backend repository is accessible"
          echo "  - Verify backend has requirements.txt or docker-compose.yml"
          echo "  - Check backend health endpoint works"
          echo ""
          echo "For more information:"
          echo "  - docs/E2E-CI-DEPENDENCY-RESOLUTION.md"
          echo "  - docs/E2E-CI-SETUP.md"
          echo ""
          echo "E2E tests will run successfully once dependencies are resolved."
          echo "═══════════════════════════════════════════════════════════"
      
      - name: Upload backend setup log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-setup-log
          path: backend-setup.log
          if-no-files-found: ignore
      
      - name: Upload Playwright report
        if: always() && steps.backend_setup.outputs.backend_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: client/playwright-report/
          retention-days: 30
      
      - name: Upload test screenshots
        if: failure() && steps.backend_setup.outputs.backend_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots
          path: client/test-results/
          retention-days: 30
      
      - name: Upload backend logs
        if: always() && steps.backend_setup.outputs.backend_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: backend-logs
          path: /tmp/backend-e2e.log
          if-no-files-found: ignore
